<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spelling Task</title>
</head>
<body>
  <h1>拼写任务</h1>

  <!-- 输入 Prolific ID -->
  <div id="idForm">
    <p>Please enter your <strong>Prolific ID</strong>:</p>
    <input type="text" id="prolificIdInput" required />
    <button id="startTaskBtn">开始任务</button>
  </div>

  <!-- 拼写任务区域 -->
  <div id="taskArea" style="display:none;">
    <p id="sentence"></p>
    <input type="text" id="answerInput" />
    <button id="submitBtn">提交</button>
  </div>

  <!-- 完成后的感谢信息 -->
  <div id="thanksMessage" style="display:none;">
    <p>谢谢！您已完成所有题目。</p>
    <button id="returnButton">返回表单</button>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getFirestore, doc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    // ✅ Firebase 配置
    const firebaseConfig = {
      apiKey: "AIzaSyA4eqoXelo_GDAB6StRH7iU5HBvlnjqmsc",
      authDomain: "spellingtask.firebaseapp.com",
      projectId: "spellingtask",
      storageBucket: "spellingtask.appspot.com",
      messagingSenderId: "754744794519",
      appId: "1:754744794519:web:57ff06a0114920a9ae78d2",
      measurementId: "G-TKTLNMDVZJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ✅ DOM 元素
    const idForm = document.getElementById("idForm");
    const startTaskBtn = document.getElementById("startTaskBtn");
    const prolificIdInput = document.getElementById("prolificIdInput");

    const taskArea = document.getElementById("taskArea");
    const sentenceP = document.getElementById("sentence");
    const answerInput = document.getElementById("answerInput");
    const submitBtn = document.getElementById("submitBtn");

    const thanksMessage = document.getElementById("thanksMessage");
    const returnButton = document.getElementById("returnButton");

    // ✅ 任务数据
    const sentences = [
      "I can has cheezburger.",
      "She dont know the answer.",
      "Their going to the park.",
      "Its a nice day.",
      "He have two dogs.",
      "The cat sleep on the couch.",
      "I has no idea.",
      "We was there yesterday.",
      "He dont like it.",
      "Its raining outside.",
      "They is my friends.",
      "I loves chocolate.",
      "She have a new car.",
      "He run fast.",
      "I are happy.",
      "This are mine.",
      "It dont matter.",
      "We was happy.",
      "He have a idea.",
      "I is ready."
    ];

    let currentIndex = 0;
    let startTime;
    let prolificId = "";

    // ✅ 填写 ID 开始任务
    startTaskBtn.addEventListener("click", () => {
      const input = prolificIdInput.value.trim();
      if (!input) {
        alert("Please enter your Prolific ID.");
        return;
      }
      prolificId = input;
      idForm.style.display = "none";
      taskArea.style.display = "block";
      showSentence(currentIndex);
    });

    // ✅ 显示句子
    function showSentence(index) {
      sentenceP.textContent = sentences[index];
      answerInput.value = "";
      answerInput.focus();
      startTime = Date.now();
    }

    // ✅ 提交按钮
    submitBtn.addEventListener("click", async () => {
      const original = sentences[currentIndex];
      const answer = answerInput.value.trim();
      const duration = (Date.now() - startTime) / 1000;

      try {
        const userDocRef = doc(db, "spellingTask", prolificId);
        const userResponsesRef = collection(userDocRef, "responses");

        await addDoc(userResponsesRef, {
          originalSentence: original,
          correctedText: answer,
          timeTakenSec: parseFloat(duration),
          timestamp: serverTimestamp()
        });
      } catch (error) {
        console.error("Firestore 保存失败:", error);
      }

      currentIndex++;
      if (currentIndex < sentences.length) {
        showSentence(currentIndex);
      } else {
        taskArea.style.display = "none";
        thanksMessage.style.display = "block";
      }
    });

    // ✅ 返回表单按钮（修改你的 Google Form 链接）
    returnButton.addEventListener("click", () => {
      window.location.href = "https://forms.gle/4ub3jVCZKjYZSGoi8";
    });
  </script>
</body>
</html>
